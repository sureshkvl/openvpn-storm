// Generated by CoffeeScript 1.9.3
(function() {
  var ClientSchema, OpenvpnClientService, OpenvpnServerService, OpenvpnService, ServerSchema, StormService, exec, fs, merge, path,
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  StormService = require('stormservice');

  merge = require('fmerge');

  fs = require('fs');

  path = require('path');

  exec = require('child_process').exec;

  ServerSchema = require('./schema').server;

  ClientSchema = require('./schema').client;

  OpenvpnService = (function(superClass) {
    extend(OpenvpnService, superClass);

    OpenvpnService.prototype.invocation = {
      name: 'openvpn',
      path: '/usr/sbin',
      monitor: true,
      args: [],
      options: {
        detached: true,
        stdio: ["ignore", -1, -1]
      }
    };

    function OpenvpnService(id, data, opts) {
      if (data.instance != null) {
        this.instance = data.instance;
        delete data.instance;
      }
      if (opts == null) {
        opts = {};
      }
      if (opts.configPath == null) {
        opts.configPath = "/var/stormflash/plugins/openvpn";
      }
      if (opts.logPath == null) {
        opts.logPath = "/var/log/openvpn";
      }
      OpenvpnService.__super__.constructor.call(this, id, data, opts);
      this.configs = {
        service: {
          filename: this.configPath + "/" + this.id + ".conf"
        }
      };
      this.invocation = merge(this.invocation, {
        args: ["--config", "" + this.configs.service.filename],
        options: {
          stdio: ["ignore", this.out, this.err]
        }
      });
      this.configs.service.generator = (function(_this) {
        return function(callback) {
          var cert, dir, filename, i, j, k, key, len, len1, ref, ref1, val, vpnconfig;
          vpnconfig = '';
          dir = _this.configPath + "/" + _this.id;
          if (!fs.existsSync(dir)) {
            fs.mkdirSync(dir);
          }
          ref = _this.data.certificates;
          for (j = 0, len = ref.length; j < len; j++) {
            cert = ref[j];
            filename = (function() {
              switch (cert.name) {
                case "ca":
                  return this.data.ca;
                case "dh":
                  return this.data.dh;
                case "cert":
                  return this.data.cert;
                case "key":
                  return this.data.key;
              }
            }).call(_this);
            path = dir + "/" + filename;
            console.log("path");
            fs.writeFileSync(path, new Buffer(cert.data || '', "base64"));
          }
          ref1 = _this.data;
          for (key in ref1) {
            val = ref1[key];
            switch (typeof val) {
              case "object":
                if (val instanceof Array) {
                  for (k = 0, len1 = val.length; k < len1; k++) {
                    i = val[k];
                    if (key === "route") {
                      vpnconfig += key + " " + i + "\n";
                    }
                    if (key === "push") {
                      vpnconfig += key + " \"" + i + "\"\n";
                    }
                  }
                }
                break;
              case "number":
              case "string":
                if (key === 'ca' || key === 'dh' || key === 'cert' || key === 'key') {
                  vpnconfig += key + ' ' + (dir + "/" + val) + "\n";
                } else {
                  vpnconfig += key + ' ' + val + "\n";
                }
                break;
              case "boolean":
                vpnconfig += key + "\n";
            }
          }
          return callback(vpnconfig);
        };
      })(this);
    }

    OpenvpnService.prototype.updateService = function(newdata, callback) {
      var ccdpath, err;
      this.data = merge(this.data, newdata);
      ccdpath = newdata["client-config-dir"];
      if (ccdpath != null) {
        try {
          fs.mkdir("" + ccdpath, function() {});
        } catch (_error) {
          err = _error;
        }
      }
      return this.generate(callback);
    };

    OpenvpnService.prototype.destructor = function() {
      this.eliminate();
      return this.emit('destroy');
    };

    return OpenvpnService;

  })(StormService);

  OpenvpnServerService = (function(superClass) {
    extend(OpenvpnServerService, superClass);

    function OpenvpnServerService(id, data, opts) {
      var ccdpath, err;
      this.schema = ServerSchema;
      ccdpath = data["client-config-dir"];
      if (ccdpath != null) {
        try {
          fs.mkdir("" + ccdpath, function() {});
        } catch (_error) {
          err = _error;
        }
      }
      OpenvpnServerService.__super__.constructor.call(this, id, data, opts);
    }

    return OpenvpnServerService;

  })(OpenvpnService);

  OpenvpnClientService = (function(superClass) {
    extend(OpenvpnClientService, superClass);

    function OpenvpnClientService(id, data, opts) {
      this.schema = ClientSchema;
      OpenvpnClientService.__super__.constructor.call(this, id, data, opts);
    }

    return OpenvpnClientService;

  })(OpenvpnService);

  module.exports.OpenvpnService = OpenvpnService;

  module.exports.OpenvpnClient = OpenvpnClientService;

  module.exports.OpenvpnServer = OpenvpnServerService;

}).call(this);
