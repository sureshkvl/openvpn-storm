// Generated by CoffeeScript 1.9.3
(function() {
  var OpenvpnClientService, OpenvpnRegistry, OpenvpnServerService, OpenvpnService, OpenvpnUserRegistry, StormData, StormRegistry, UserData,
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  StormRegistry = require('stormregistry');

  StormData = require('stormdata');

  OpenvpnService = require('./openvpn-service').OpenvpnService;

  OpenvpnClientService = require('./openvpn-service').OpenvpnClient;

  OpenvpnServerService = require('./openvpn-service').OpenvpnServer;

  OpenvpnRegistry = (function(superClass) {
    extend(OpenvpnRegistry, superClass);

    function OpenvpnRegistry(svc, filename) {
      this.svc = svc;
      this.on('load', function(key, val) {
        var entry;
        console.log("restoring " + key + " with:", val);
        if (this.svc === "client") {
          entry = new OpenvpnClientService(key, val);
        } else {
          entry = new OpenvpnServerService(key, val);
        }
        if (entry != null) {
          entry.saved = true;
          return this.add(entry);
        }
      });
      this.on('removed', function(entry) {
        if (entry.destructor != null) {
          return entry.destructor();
        }
      });
      OpenvpnRegistry.__super__.constructor.call(this, filename);
    }

    OpenvpnRegistry.prototype.add = function(service) {
      var entry;
      if (this.svc === "client") {
        if (!(service instanceof OpenvpnClientService)) {
          return;
        }
      } else {
        if (!(service instanceof OpenvpnServerService)) {
          return;
        }
      }
      entry = OpenvpnRegistry.__super__.add.call(this, service.id, service);
      return entry.on("running", (function(_this) {
        return function(instance) {
          if (entry.instance !== instance) {
            entry.instance = instance;
            return _this.update(entry);
          }
        };
      })(this));
    };

    OpenvpnRegistry.prototype.update = function(service) {
      service.data.instance = service.instance;
      OpenvpnRegistry.__super__.update.call(this, service.id, service);
      return delete service.data.instance;
    };

    OpenvpnRegistry.prototype.list = function() {
      var j, len, result, results, service, services;
      results = [];
      result = {};
      services = OpenvpnRegistry.__super__.list.apply(this, arguments);
      for (j = 0, len = services.length; j < len; j++) {
        service = services[j];
        result = service.data;
        result.id = service.id;
        results.push(result);
      }
      return results;
    };

    return OpenvpnRegistry;

  })(StormRegistry);


  /*
      get: (key) ->
          entry = super key
          return unless entry?
  
          if entry.data? and entry.data 
              entry.data.id = entry.id
              entry.data
          else
              entry
   */

  UserData = (function(superClass) {
    var userSchema;

    extend(UserData, superClass);

    userSchema = require('./schema').user;

    function UserData(id, data) {
      UserData.__super__.constructor.call(this, id, data, userSchema);
    }

    return UserData;

  })(StormData);

  OpenvpnUserRegistry = (function(superClass) {
    var fs;

    extend(OpenvpnUserRegistry, superClass);

    fs = require('fs');

    function OpenvpnUserRegistry(filename) {
      this.on('load', function(key, val) {
        var entry;
        entry = new UserData(key, val);
        if (entry != null) {
          entry.saved = true;
          return this.add(key, entry);
        }
      });
      this.on('removed', function(key) {});
      OpenvpnUserRegistry.__super__.constructor.call(this, filename);
      this.on('added', function(entry) {});
    }

    OpenvpnUserRegistry.prototype.get = function(key) {
      var entry;
      entry = OpenvpnUserRegistry.__super__.get.call(this, key);
      if (entry == null) {
        return;
      }
      if ((entry.data != null) && entry.data instanceof UserData) {
        entry.data.id = entry.id;
        return entry.data;
      } else {
        return entry;
      }
    };

    OpenvpnUserRegistry.prototype.adduser = function(user) {
      var file, filename, gconfig, i, j, key, len, val;
      file = user.cname ? user.cname : user.email;
      filename = user.ccdpath + "/" + ("" + file);
      gconfig = '';
      for (key in user) {
        val = user[key];
        switch (typeof val) {
          case "object":
            if (val instanceof Array) {
              for (j = 0, len = val.length; j < len; j++) {
                i = val[j];
                if (key === "iroute") {
                  gconfig += key + " " + i + "\n";
                }
                if (key === "push") {
                  gconfig += key + " \"" + i + "\"\n";
                }
              }
            }
        }
      }
      console.log("filename for ccd generated is ", filename);
      return fs.writeFileSync(filename, gconfig);
    };

    OpenvpnUserRegistry.prototype.deleteuser = function(server, user, callback) {
      var ccdpath, cname, email, exists, file, filename, path;
      path = require('path');
      ccdpath = server["client-config-dir"];
      cname = user["cname"];
      email = user["email"];
      file = cname ? cname : email;
      filename = ccdpath + "/" + ("" + file);
      console.log(filename);
      exists = path.existsSync(filename);
      if (!exists) {
        console.log('file removed already');
        return callback(new Error("user is already removed!"));
      }
      return fs.unlink(filename, (function(_this) {
        return function(err) {
          if (err) {
            return callback(err);
          } else {
            console.log('removed file');
            return callback(true);
          }
        };
      })(this));
    };

    return OpenvpnUserRegistry;

  })(StormRegistry);

  module.exports.OpenvpnRegistry = OpenvpnRegistry;

  module.exports.OpenvpnUserRegistry = OpenvpnUserRegistry;

}).call(this);
